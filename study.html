<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Materials | Student Companion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        * {
            font-family: 'Poppins', sans-serif;
        }
        .auth-container {
            background: linear-gradient(135deg, #6366f1 0%, #3b82f6 100%);
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        :root {
            color-scheme: light dark;
        }
        .nav-link {
            transition: all 0.3s ease;
        }
        .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900">
    <div id="homepage" class="min-h-screen">
        <!-- Navbar -->
        <nav class="bg-indigo-600 text-white shadow-lg sticky top-0 z-50">
            <div class="container mx-auto px-4">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center space-x-4">
                        <h1 class="text-2xl font-bold">Student Companion</h1>
                        <span id="welcomeMessage" class="hidden md:inline text-sm">Welcome, <span id="userName">User</span>!</span>
                    </div>
                    
                    <div class="flex items-center">
                        <button id="logoutBtn" class="py-1 px-2 md:py-2 md:px-4 text-xs md:text-base rounded-lg bg-white bg-opacity-20 hover:bg-opacity-30 transition ml-2" onclick="logout()">Logout</button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Flex Container for Sidebar and Content -->
        <div class="flex flex-col md:flex-row">
            <!-- Sidebar -->
            <div id="sidebar" class="fixed md:relative w-64 bg-indigo-800 text-white h-screen z-40 transform -translate-x-full md:translate-x-0 transition-transform duration-300">
                <div class="p-4">
                    <h2 class="text-xl font-semibold mb-4">Features</h2>
                    <ul class="space-y-2">
                        <li><a href="notice.html" class="block py-2 px-4 rounded-lg nav-link" onclick="loadContent('notice')">Notice Board</a></li>
                        <li><a href="taxi-search.html" class="block py-2 px-4 rounded-lg nav-link">Taxi Search</a></li>
                        <li><a href="#" class="block py-2 px-4 rounded-lg nav-link active bg-indigo-700" onclick="loadContent('study')">Study Materials</a></li>
                        <li><a href="mail.html" class="block py-2 px-4 rounded-lg nav-link" onclick="loadContent('mail')">Mail Formats</a></li>
                        <li><a href="kyp.html" class="block py-2 px-4 rounded-lg nav-link">Know Your People</a></li>
                        <li><a href="outings.html" class="block py-2 px-4 rounded-lg nav-link">Outings & Trips</a></li>
                        <li><a href="messmenu.html" class="block py-2 px-4 rounded-lg nav-link">Mess & Canteen</a></li>
                    </ul>
                </div>
            </div>

            <!-- Mobile Sidebar Toggle Button -->
            <div class="fixed bottom-4 left-4 z-40 md:hidden">
                <button onclick="toggleSidebar()" class="bg-indigo-600 text-white p-3 rounded-full shadow-lg">
                    <i class="bi bi-list text-xl"></i>
                </button>
            </div>

            <!-- Main Content -->
            <div class="flex-1 p-4 md:p-8">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 md:p-6">
                    <!-- Study Materials Content -->
                    <div class="mb-6 flex justify-between items-center">
                        <div>
                            <h1 class="text-2xl font-bold text-gray-800 dark:text-white">Study Materials</h1>
                            <p class="text-gray-600 dark:text-gray-300 mt-2">Access study resources for your courses</p>
                        </div>
                        <!-- Admin-only Add Material Button -->
                        <div id="adminControls" class="hidden">
                            <button id="addMaterialBtn" class="bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700">
                                <i class="bi bi-plus-lg mr-1"></i> Add Material
                            </button>
                        </div>
                    </div>

                    <!-- Search and Filter -->
                    <div class="flex flex-wrap gap-4 mb-6">
                        <div class="flex-1">
                            <input type="text" id="materialSearch" placeholder="Search materials..." class="w-full px-4 py-2 rounded-lg border focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>
                        <select class="px-4 py-2 rounded-lg border focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            <option value="">All Departments</option>
                            <option value="cs">Computer Science</option>
                            <option value="ee">Electrical Engineering</option>
                            <option value="me">Mechanical Engineering</option>
                        </select>
                        <select class="px-4 py-2 rounded-lg border focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            <option value="">All Semesters</option>
                            <option value="1">Semester 1</option>
                            <option value="2">Semester 2</option>
                            <option value="3">Semester 3</option>
                        </select>
                    </div>

                    <!-- Materials List -->
                    <div class="space-y-4">
                        <!-- Material Card -->
                        <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow-md hover:shadow-lg transition-shadow">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="font-medium text-gray-800 dark:text-white">Data Structures Notes</h3>
                                    <p class="text-sm text-gray-600 dark:text-gray-300">Computer Science • Semester 3</p>
                                </div>
                                <div class="flex">
                                    <!-- Admin Actions (Hidden by Default) -->
                                    <div class="admin-actions hidden mr-2">
                                        <button class="text-blue-600 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 mx-1">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="text-red-600 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 mx-1">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                    <!-- View Link Button -->
                                    <a href="materials/data-structures.pdf" target="_blank" class="text-indigo-600 hover:text-indigo-700 dark:text-indigo-400 dark:hover:text-indigo-300 px-3 py-1 border border-indigo-600 dark:border-indigo-400 rounded-lg">
                                        <i class="bi bi-eye mr-1"></i> View
                                    </a>
                                </div>
                            </div>
                            <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">Uploaded by Prof. Smith • 2 days ago</p>
                        </div>

                        <!-- More Material Cards -->
                        <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow-md hover:shadow-lg transition-shadow">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="font-medium text-gray-800 dark:text-white">Circuit Theory Practice Problems</h3>
                                    <p class="text-sm text-gray-600 dark:text-gray-300">Electrical Engineering • Semester 2</p>
                                </div>
                                <div class="flex">
                                    <!-- Admin Actions (Hidden by Default) -->
                                    <div class="admin-actions hidden mr-2">
                                        <button class="text-blue-600 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 mx-1">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="text-red-600 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 mx-1">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                    <!-- View Link Button -->
                                    <a href="materials/circuit-theory.pdf" target="_blank" class="text-indigo-600 hover:text-indigo-700 dark:text-indigo-400 dark:hover:text-indigo-300 px-3 py-1 border border-indigo-600 dark:border-indigo-400 rounded-lg">
                                        <i class="bi bi-eye mr-1"></i> View
                                    </a>
                                </div>
                            </div>
                            <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">Uploaded by Dr. Johnson • 5 days ago</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Material Modal (Admin Only) -->
    <div id="materialModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white dark:bg-gray-800 dark:border-gray-700">
            <div class="mt-3">
                <h3 id="modalTitle" class="text-lg font-medium leading-6 text-gray-900 dark:text-white mb-4">Add Study Material</h3>
                <form id="materialForm">
                    <input type="text" id="materialTitle" placeholder="Material Title" class="w-full px-3 py-2 border rounded-lg mb-3 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    
                    <select id="materialDepartment" class="w-full px-3 py-2 border rounded-lg mb-3 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        <option value="">Select Department</option>
                        <option value="cs">Computer Science</option>
                        <option value="ee">Electrical Engineering</option>
                        <option value="me">Mechanical Engineering</option>
                    </select>
                    
                    <select id="materialSemester" class="w-full px-3 py-2 border rounded-lg mb-3 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        <option value="">Select Semester</option>
                        <option value="1">Semester 1</option>
                        <option value="2">Semester 2</option>
                        <option value="3">Semester 3</option>
                    </select>
                    
                    <input type="text" id="materialLink" placeholder="Material Link URL" class="w-full px-3 py-2 border rounded-lg mb-3 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    
                    <input type="text" id="materialUploader" placeholder="Uploaded by" class="w-full px-3 py-2 border rounded-lg mb-3 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    
                    <div class="flex justify-end space-x-3">
                        <button type="button" id="cancelBtn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 dark:bg-gray-700 dark:text-white dark:hover:bg-gray-600">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Supabase
    const supabaseUrl = 'https://cebomekzvltlaabcvjix.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNlYm9tZWt6dmx0bGFhYmN2aml4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM3NjUwNjQsImV4cCI6MjA1OTM0MTA2NH0.dtlBNgdctrv-txCEpNxjpfwzL02X0g7msUZIVuzG9J8';
    
    // Create a proper client instance
    window.supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
    
    // Check if on auth page
    if (document.getElementById('authPage')) {
        // Initialize auth handlers
        initializeAuthHandlers();
        
        // Check session on page load
        checkSession();
    } else {
        // On homepage - check for existing user session
        const userData = sessionStorage.getItem('currentUserData');
        if (userData) {
            const user = JSON.parse(userData);
            document.getElementById('userName').textContent = user.name;
            document.getElementById('welcomeMessage').classList.remove('hidden');
            
            // Check if user is admin and show admin controls
            if (user.name === 'Admin') {
                document.getElementById('adminControls').classList.remove('hidden');
                const adminActions = document.querySelectorAll('.admin-actions');
                adminActions.forEach(element => {
                    element.classList.remove('hidden');
                });
            }
            
            // Initialize materials from Supabase
            initializeMaterialsFromSupabase();
        } else {
            // Redirect to login page if not logged in
            window.location.href = 'index.html';
        }
    }
});


async function logout() {
    try {
        const { error } = await window.supabaseClient.auth.signOut();
        if (error) throw error;
        
        // Clear session storage
        sessionStorage.removeItem('currentUserData');
        
        // Redirect to login page
        window.location.href = 'index.html';
    } catch (error) {
        alert('Error signing out: ' + error.message);
    }
}

async function checkSession() {
    try {
        // Check if user is logged in with Supabase
        const { data: { session } } = await window.supabaseClient.auth.getSession();
        
        if (session) {
            // User is logged in, get profile
            const { data: profile, error } = await window.supabaseClient
                .from('profiles')
                .select('name, is_admin')
                .eq('id', session.user.id)
                .single();
                
            if (!error && profile) {
                // Check if admin user
                const userName = profile.is_admin ? 'Admin' : profile.name;
                showHomepage(userName);
                
                // Check for page parameter in URL
                const urlParams = new URLSearchParams(window.location.search);
                const page = urlParams.get('page');
                if (page) {
                    loadContent(page);
                }
            }
        }
    } catch (error) {
        console.error('Error checking session:', error);
    }
}

function switchTab(tab) {
    const forms = {
        login: document.getElementById('loginForm'),
        admin: document.getElementById('adminForm'),
        register: document.getElementById('registerForm')
    };
    
    // Hide all forms
    Object.values(forms).forEach(form => form.classList.add('hidden'));
    
    // Show selected form
    forms[tab].classList.remove('hidden');
    
    // Update active tab styling
    document.querySelectorAll('button').forEach(btn => {
        btn.classList.remove('bg-opacity-30');
    });
    document.getElementById(`${tab}Tab`).classList.add('bg-opacity-30');
}

function showHomepage(userName) {
    // On Auth page
    if (document.getElementById('authPage')) {
        // Hide auth page
        document.getElementById('authPage').style.display = 'none';
        
        // Show homepage
        document.getElementById('homepage').style.display = 'block';
        
        // Store user info in sessionStorage
        sessionStorage.setItem('currentUserData', JSON.stringify({
            name: userName
        }));
        
        // Redirect to homepage
        window.location.href = 'homepage.html';
    } else {
        // Already on homepage
        document.getElementById('userName').textContent = userName;
        document.getElementById('welcomeMessage').classList.remove('hidden');
        
        // Check if user is admin and show admin controls
        if (userName === 'Admin') {
            document.getElementById('adminControls').classList.remove('hidden');
            const adminActions = document.querySelectorAll('.admin-actions');
            adminActions.forEach(element => {
                element.classList.remove('hidden');
            });
        }
    }
}

// Toggle sidebar for mobile
function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    sidebar.classList.toggle('-translate-x-full');
}

// STUDY MATERIALS MANAGEMENT WITH SUPABASE INTEGRATION

// Modal Functionality for Add/Edit Material (Admin Only)
const materialModal = document.getElementById('materialModal');
const addMaterialBtn = document.getElementById('addMaterialBtn');
const cancelBtn = document.getElementById('cancelBtn');
const materialForm = document.getElementById('materialForm');

// Show modal when Add Material button is clicked
if (addMaterialBtn) {
    addMaterialBtn.onclick = function() {
        document.getElementById('modalTitle').textContent = 'Add Study Material';
        document.getElementById('materialTitle').value = '';
        document.getElementById('materialDepartment').value = '';
        document.getElementById('materialSemester').value = '';
        document.getElementById('materialLink').value = '';
        document.getElementById('materialUploader').value = '';
        delete materialForm.dataset.materialId; // Remove any stored ID when adding new
        materialModal.classList.remove('hidden');
    }
}

// Cancel button closes modal
if (cancelBtn) {
    cancelBtn.onclick = function() {
        materialModal.classList.add('hidden');
    }
}

// Supabase Functions for Materials
async function initializeMaterialsFromSupabase() {
    try {
        const { data: materials, error } = await window.supabaseClient
            .from('materials')
            .select('*')
            .order('created_at', { ascending: false });
            
        if (error) throw error;
        
        if (materials && materials.length > 0) {
            const materialsList = document.querySelector('.space-y-4');
            materialsList.innerHTML = ''; // Clear existing content
            
            // Add each material to the list
            materials.forEach(material => {
                const newMaterial = createMaterialCard(material);
                materialsList.appendChild(newMaterial);
            });
        } else {
            // If no materials found, initialize demo materials
            initializeDemoMaterials();
        }
    } catch (error) {
        console.error('Error fetching materials:', error);
        // Fallback to demo materials
        initializeDemoMaterials();
    }
}

function createMaterialCard(material) {
    const newMaterial = document.createElement('div');
    newMaterial.classList.add('bg-white', 'dark:bg-gray-700', 'p-4', 'rounded-lg', 'shadow-md', 'hover:shadow-lg', 'transition-shadow');
    
    const departmentText = getDepartmentText(material.department);
    const semesterText = material.semester ? `Semester ${material.semester}` : '';
    const timeAgo = formatTimeAgo(material.created_at || new Date().toISOString());
    
    newMaterial.innerHTML = `
        <div class="flex justify-between items-start">
            <div>
                <h3 class="font-medium text-gray-800 dark:text-white">${material.title}</h3>
                <p class="text-sm text-gray-600 dark:text-gray-300">${departmentText} • ${semesterText}</p>
            </div>
            <div class="flex">
                <div class="admin-actions mr-2 ${sessionStorage.getItem('currentUserData') && JSON.parse(sessionStorage.getItem('currentUserData')).name === 'Admin' ? '' : 'hidden'}">
                    <button class="text-blue-600 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 mx-1 edit-button" data-id="${material.id}">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="text-red-600 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 mx-1 delete-button" data-id="${material.id}">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
                <a href="${material.link}" target="_blank" class="text-indigo-600 hover:text-indigo-700 dark:text-indigo-400 dark:hover:text-indigo-300 px-3 py-1 border border-indigo-600 dark:border-indigo-400 rounded-lg">
                    <i class="bi bi-eye mr-1"></i> View
                </a>
            </div>
        </div>
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">Uploaded by ${material.uploader} • ${timeAgo}</p>
    `;
    
    return newMaterial;
}

function formatTimeAgo(dateString) {
    if (!dateString) return 'Just now';
    
    const date = new Date(dateString);
    const now = new Date();
    const diffTime = Math.abs(now - date);
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
    
    if (diffDays === 0) {
        const diffHours = Math.floor(diffTime / (1000 * 60 * 60));
        if (diffHours === 0) {
            const diffMinutes = Math.floor(diffTime / (1000 * 60));
            return diffMinutes <= 1 ? 'Just now' : `${diffMinutes} minutes ago`;
        }
        return `${diffHours} hours ago`;
    } else if (diffDays === 1) {
        return 'Yesterday';
    } else if (diffDays < 7) {
        return `${diffDays} days ago`;
    } else if (diffDays < 30) {
        const diffWeeks = Math.floor(diffDays / 7);
        return `${diffWeeks} ${diffWeeks === 1 ? 'week' : 'weeks'} ago`;
    } else {
        const diffMonths = Math.floor(diffDays / 30);
        return `${diffMonths} ${diffMonths === 1 ? 'month' : 'months'} ago`;
    }
}

async function addMaterialToSupabase(material) {
    try {
        const { data, error } = await window.supabaseClient
            .from('materials')
            .insert([material])
            .select();
            
        if (error) throw error;
        
        return data[0];
    } catch (error) {
        console.error('Error adding material:', error);
        return null;
    }
}

async function updateMaterialInSupabase(id, material) {
    try {
        const { data, error } = await window.supabaseClient
            .from('materials')
            .update(material)
            .eq('id', id)
            .select();
            
        if (error) throw error;
        
        return data[0];
    } catch (error) {
        console.error('Error updating material:', error);
        return null;
    }
}

async function deleteMaterialFromSupabase(id) {
    try {
        const { error } = await window.supabaseClient
            .from('materials')
            .delete()
            .eq('id', id);
            
        if (error) throw error;
        
        return true;
    } catch (error) {
        console.error('Error deleting material:', error);
        return false;
    }
}

// Form submission with Supabase integration
if (materialForm) {
    materialForm.onsubmit = async function(e) {
        e.preventDefault();
        
        // Get form values
        const title = document.getElementById('materialTitle').value;
        const department = document.getElementById('materialDepartment').value;
        const semester = document.getElementById('materialSemester').value;
        const link = document.getElementById('materialLink').value;
        const uploader = document.getElementById('materialUploader').value;
        
        // Get the material ID (if editing)
        const materialId = materialForm.dataset.materialId;

        // Create the material object
        const materialData = {
            title: title,
            department: department,
            semester: semester,
            link: link,
            uploader: uploader
        };
        
        try {
            if (materialId) {
                // Update existing material
                const updatedMaterial = await updateMaterialInSupabase(materialId, materialData);
                
                if (updatedMaterial) {
                    // Find and update the material card in the DOM
                    const materialCard = document.querySelector(`button[data-id="${materialId}"]`).closest('.bg-white');
                    const newCard = createMaterialCard(updatedMaterial);
                    materialCard.replaceWith(newCard);
                }
            } else {
                // Add new material
                const newMaterial = await addMaterialToSupabase(materialData);
                
                if (newMaterial) {
                    // Create and add the new material card to the DOM
                    const materialCard = createMaterialCard(newMaterial);
                    const materialsList = document.querySelector('.space-y-4');
                    materialsList.prepend(materialCard);
                }
            }
            
            // Close the modal
            materialModal.classList.add('hidden');
            
            // Clear the form
            materialForm.reset();
            delete materialForm.dataset.materialId;
        } catch (error) {
            alert('Error saving material: ' + error.message);
        }
    };
}

// Search Functionality
const materialSearchInput = document.getElementById('materialSearch');
if (materialSearchInput) {
    materialSearchInput.addEventListener('input', function() {
        const searchTerm = materialSearchInput.value.toLowerCase();
        const materialCards = document.querySelectorAll('.space-y-4 > div');

        materialCards.forEach(card => {
            const title = card.querySelector('h3').textContent.toLowerCase();
            const details = card.querySelector('p').textContent.toLowerCase();
            if (title.includes(searchTerm) || details.includes(searchTerm)) {
                card.style.display = '';
            } else {
                card.style.display = 'none';
            }
        });
    });
}

// Close modal when clicking outside
window.onclick = function(event) {
    if (event.target == materialModal) {
        materialModal.classList.add('hidden');
    }
}

// Event delegation for Edit and Delete functionality
document.addEventListener('click', async function(e) {
    // Edit button clicked
    if (e.target.closest('.edit-button') || e.target.classList.contains('bi-pencil')) {
        const editButton = e.target.closest('.edit-button') || e.target.closest('.bi-pencil').parentElement;
        const materialId = editButton.getAttribute('data-id');
        
        // Check if materialId is valid before making the request
        if (!materialId || materialId === 'undefined') {
            console.error('Invalid material ID for edit');
            alert('Error: Could not identify the material to edit');
            return;
        }
        
        try {
            // Get material data from Supabase
            const { data: material, error } = await window.supabaseClient
                .from('materials')
                .select('*')
                .eq('id', materialId)
                .single();
                
            if (error) throw error;
            
            if (material) {
                // Fill the form with existing data
                document.getElementById('modalTitle').textContent = 'Edit Study Material';
                document.getElementById('materialTitle').value = material.title;
                document.getElementById('materialDepartment').value = material.department;
                document.getElementById('materialSemester').value = material.semester || '';
                document.getElementById('materialLink').value = material.link;
                document.getElementById('materialUploader').value = material.uploader;
                
                // Store the material ID in the form
                materialForm.dataset.materialId = materialId;
                
                materialModal.classList.remove('hidden');
            }
        } catch (error) {
            console.error('Error fetching material for edit:', error);
            alert('Error loading material data: ' + error.message);
        }
    }
    // Delete button clicked
    else if (e.target.closest('.delete-button') || e.target.closest('.bi-trash')) {
        const deleteButton = e.target.closest('.delete-button') || e.target.closest('.bi-trash').parentElement;
        const materialId = deleteButton.dataset.id;
        
        if (confirm('Are you sure you want to delete this material?')) {
            try {
                // Delete from Supabase
                const success = await deleteMaterialFromSupabase(materialId);
                
                if (success) {
                    // Remove from DOM
                    const card = deleteButton.closest('.bg-white');
                    card.remove();
                }
            } catch (error) {
                console.error('Error deleting material:', error);
                alert('Error deleting material');
            }
        }
    }
});

// Helper functions
function getDepartmentText(code) {
    switch(code) {
        case 'cs': return 'Computer Science';
        case 'ee': return 'Electrical Engineering';
        case 'me': return 'Mechanical Engineering';
        default: return code || '';
    }
}

function getDepartmentCode(text) {
    switch(text.trim()) {
        case 'Computer Science': return 'cs';
        case 'Electrical Engineering': return 'ee';
        case 'Mechanical Engineering': return 'me';
        default: return text || '';
    }
}

// Function to initialize demo materials in Supabase
async function initializeDemoMaterials() {
    try {
        // Check if materials table is empty
        const { data: existingMaterials, error: checkError } = await window.supabaseClient
            .from('materials')
            .select('id')
            .limit(1);
            
        if (checkError) throw checkError;
        
        if (!existingMaterials || existingMaterials.length === 0) {
            // Add demo materials to Supabase
            const demoMaterials = [
                {
                    title: "Data Structures Notes",
                    department: "cs",
                    semester: "3",
                    link: "materials/data-structures.pdf",
                    uploader: "Prof. Smith"
                },
                {
                    title: "Circuit Theory Practice Problems",
                    department: "ee",
                    semester: "2",
                    link: "materials/circuit-theory.pdf",
                    uploader: "Dr. Johnson"
                }
            ];
            
            const { data, error } = await window.supabaseClient
                .from('materials')
                .insert(demoMaterials)
                .select();
                
            if (error) throw error;
            
            // Add demo materials to DOM
            const materialsList = document.querySelector('.space-y-4');
            data.forEach(material => {
                const newMaterial = createMaterialCard(material);
                materialsList.appendChild(newMaterial);
            });
        }
    } catch (error) {
        console.error('Error initializing demo materials:', error);
    }
}

// Check for system dark mode preference
if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
    document.documentElement.classList.add('dark');
}
    </script>
</body>
</html>