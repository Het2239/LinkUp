<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinkUp</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    animation: {
                        'fade-in': 'fadeIn 0.6s ease-out',
                        'slide-in': 'slideIn 0.6s ease-out',
                        'pulse-slow': 'pulse 3s infinite',
                        'float': 'float 6s ease-in-out infinite',
                        'bob': 'bob 4s ease-in-out infinite',
                        'spin-slow': 'spin 15s linear infinite',
                        'zoom': 'zoom 10s ease infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' }
                        },
                        slideIn: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' }
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-20px)' }
                        },
                        bob: {
                            '0%, 100%': { transform: 'translateY(0) rotate(0deg)' },
                            '50%': { transform: 'translateY(-10px) rotate(5deg)' }
                        },
                        zoom: {
                            '0%, 100%': { transform: 'scale(1)' },
                            '50%': { transform: 'scale(1.05)' }
                        }
                    },
                    backgroundImage: {
                        'gradient-radial': 'radial-gradient(var(--tw-gradient-stops))',
                    },
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e'
                        },
                        secondary: {
                            50: '#faf5ff',
                            100: '#f3e8ff',
                            200: '#e9d5ff',
                            300: '#d8b4fe',
                            400: '#c084fc',
                            500: '#a855f7',
                            600: '#9333ea',
                            700: '#7e22ce',
                            800: '#6b21a8',
                            900: '#581c87'
                        },
                        tertiary: {
                            50: '#fff7ed',
                            100: '#ffedd5',
                            200: '#fed7aa',
                            300: '#fdba74',
                            400: '#fb923c',
                            500: '#f97316',
                            600: '#ea580c',
                            700: '#c2410c',
                            800: '#9a3412',
                            900: '#7c2d12'
                        }
                    }
                }
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Outfit', sans-serif;
        }
        
        .floating-shape {
            position: absolute;
            opacity: 0.7;
            border-radius: 50%;
            filter: blur(20px);
            z-index: 0;
        }
        
        #homepage {
            display: none;
        }
        
        .animate-delay-1 {
            animation-delay: 0.2s;
        }
        
        .animate-delay-2 {
            animation-delay: 0.4s;
        }
        
        .animate-delay-3 {
            animation-delay: 0.6s;
        }
        
        .animate-delay-4 {
            animation-delay: 0.8s;
        }
        
        /* Sidebar hover effect */
        .sidebar-item {
            position: relative;
            overflow: hidden;
        }
        
        .sidebar-item::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 0;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.1);
            transition: width 0.3s ease;
            z-index: -1;
        }
        
        .sidebar-item:hover::after {
            width: 100%;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(156, 163, 175, 0.5);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(156, 163, 175, 0.8);
        }
    </style>
    <!-- Add these styles to your existing <style> tag -->
<style>
    /* Mobile optimizations */
    @media (max-width: 640px) {
        .floating-shape {
            opacity: 0.4;
            filter: blur(30px);
        }
        
        #contentArea {
            padding: 1rem !important;
        }
    }
    
    /* Tablet optimizations */
    @media (min-width: 641px) and (max-width: 1024px) {
        .floating-shape {
            opacity: 0.5;
            filter: blur(25px);
        }
    }
    
    /* Animations for mobile */
    @media (prefers-reduced-motion: reduce) {
        .animate-float, .animate-bob, .animate-spin-slow, .animate-zoom {
            animation: none !important;
        }
    }
    
    /* Responsive sidebar */
    @media (max-width: 768px) {
        #sidebar {
            width: 240px;
        }
    }
    
    /* Smoother transitions */
    .content-section {
        transition: opacity 0.3s ease;
    }
    
    .content-section.hidden {
        display: none;
        opacity: 0;
    }
    
    /* Notification animation */
    @keyframes slideInUp {
        from {
            transform: translateY(100%);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
    
    .notification-enter {
        animation: slideInUp 0.3s forwards;
    }
    
    /* Fix for mobile view content padding */
    #contentArea {
        transition: margin-left 0.3s ease;
    }
    
    /* Better mobile form experience */
    input, select, textarea {
        font-size: 16px !important; /* Prevents iOS zoom on focus */
    }
    /* Additional responsive utilities */

</style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 transition-colors duration-300">
    <!-- Navbar -->
    <nav class="bg-gradient-to-r from-primary-600 to-secondary-600 dark:from-primary-800 dark:to-secondary-800 text-white shadow-lg sticky top-0 z-50 transition-colors duration-300">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <i class="bi bi-mortarboard-fill text-2xl"></i>
                        <h1 class="text-xl md:text-2xl font-bold">LinkUp</h1>
                    </div>
                    <span id="welcomeMessage" class="hidden md:inline text-sm bg-white/10 py-1 px-3 rounded-full">
                        <i class="bi bi-person-check mr-1"></i>
                        Welcome, <span id="userName" class="font-medium">User</span>!
                    </span>
                </div>
                
                <div class="flex items-center space-x-3">
                    <!-- Theme Toggle Button -->
                    <button id="themeToggleBtn" class="p-2 rounded-full bg-white/10 hover:bg-white/20 transition-all duration-300" onclick="toggleTheme()">
                        <i id="themeIcon" class="bi bi-sun text-lg"></i>
                    </button>
                    
                    <button id="logoutbtn" class="py-1 px-2 md:py-2 md:px-4 text-xs md:text-base rounded-lg bg-white/20 hover:bg-white/30 transition-all duration-300 transform hover:-translate-y-1 flex items-center space-x-1" onclick="logout()">
                        <i class="bi bi-box-arrow-right"></i>
                        <span class="hidden md:inline">Logout</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>
    <!-- Mobile Menu -->
    <div id="mobileMenu" class="hidden md:hidden bg-primary-700 dark:bg-primary-900 text-white transition-colors duration-300">
        <div class="container mx-auto px-4 py-2">
            <button class="w-full text-left py-2 px-4 hover:bg-primary-600 dark:hover:bg-primary-800 rounded-lg transition-colors duration-300 flex items-center space-x-2" onclick="logout()">
                <i class="bi bi-box-arrow-right"></i>
                <span>Logout</span>
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="flex flex-col md:flex-row">
        <!-- Sidebar -->
        <div id="sidebar" class="fixed md:relative w-64 bg-gradient-to-b from-primary-800 via-primary-700 to-secondary-700 dark:from-gray-800 dark:via-gray-800 dark:to-gray-900 text-white min-h-screen z-40 transform -translate-x-full md:translate-x-0 transition-all duration-300 shadow-xl overflow-auto">
               <div class="p-4">
                <div class="mb-6 flex items-center justify-center">
                    <div class="w-12 h-12 rounded-full flex items-center justify-center bg-white/10 hover:bg-white/20 transition-all duration-300 cursor-pointer animate-pulse-slow">
                        <i class="bi bi-mortarboard-fill text-2xl"></i>
                    </div>
                </div>
                
                <h2 class="text-xl font-semibold mb-6 pb-2 border-b border-white/20 dark:border-gray-700/50 flex items-center">
                    <i class="bi bi-grid-fill mr-2"></i>
                    Features
                </h2>
                
                <ul class="space-y-2">
                    <li class="sidebar-item">
                        <a href="notice.html" class="block py-3 px-4 rounded-lg hover:bg-white/10 dark:hover:bg-gray-700/30 transition-all duration-300 flex items-center space-x-3">
                            <div class="w-8 h-8 rounded-lg bg-white/10 flex items-center justify-center">
                                <i class="bi bi-megaphone"></i>
                            </div>
                            <span>Notice Board</span>
                        </a>
                    </li>
                    <li class="sidebar-item">
                        <a href="taxi-search.html" class="block py-3 px-4 rounded-lg hover:bg-white/10 dark:hover:bg-gray-700/30 transition-all duration-300 flex items-center space-x-3">
                            <div class="w-8 h-8 rounded-lg bg-white/10 flex items-center justify-center">
                                <i class="bi bi-car-front"></i>
                            </div>
                            <span>Taxi Search</span>
                        </a>
                    </li>
                    <li class="sidebar-item">
                        <a href="study.html" class="block py-3 px-4 rounded-lg hover:bg-white/10 dark:hover:bg-gray-700/30 transition-all duration-300 flex items-center space-x-3">
                            <div class="w-8 h-8 rounded-lg bg-white/10 flex items-center justify-center">
                                <i class="bi bi-book"></i>
                            </div>
                            <span>Study Materials</span>
                        </a>
                    </li>
                    <li class="sidebar-item">
                        <a href="mail.html" class="block py-3 px-4 rounded-lg hover:bg-white/10 dark:hover:bg-gray-700/30 transition-all duration-300 flex items-center space-x-3">
                            <div class="w-8 h-8 rounded-lg bg-white/10 flex items-center justify-center">
                                <i class="bi bi-envelope"></i>
                            </div>
                            <span>Mail Formats</span>
                        </a>
                    </li>
                    <li class="sidebar-item">
                        <a href="kyp.html" class="block py-3 px-4 rounded-lg hover:bg-white/10 dark:hover:bg-gray-700/30 transition-all duration-300 flex items-center space-x-3">
                            <div class="w-8 h-8 rounded-lg bg-white/10 flex items-center justify-center">
                                <i class="bi bi-people"></i>
                            </div>
                            <span>Know Your People</span>
                        </a>
                    </li>
                    <li class="sidebar-item">
                        <a href="outings.html" class="block py-3 px-4 rounded-lg hover:bg-white/10 dark:hover:bg-gray-700/30 transition-all duration-300 flex items-center space-x-3">
                            <div class="w-8 h-8 rounded-lg bg-white/10 flex items-center justify-center">
                                <i class="bi bi-geo"></i>
                            </div>
                            <span>Outings & Trips</span>
                        </a>
                    </li>
                    <li class="sidebar-item">
                        <a href="messmenu.html" class="block py-3 px-4 rounded-lg hover:bg-white/10 dark:hover:bg-gray-700/30 transition-all duration-300 flex items-center space-x-3">
                            <div class="w-8 h-8 rounded-lg bg-white/10 flex items-center justify-center">
                                <i class="bi bi-cup-hot"></i>
                            </div>
                            <span>Mess & Canteen</span>
                        </a>
                    </li>
                </ul>
            </div>
            
            <!-- Sidebar Footer -->
            <div class="mt-auto p-4 border-t border-white/10 dark:border-gray-700/30">
                <div class="text-xs text-white/50 text-center">
                    <p>© 2025 LinkUp</p>
                </div>
            </div>
        </div>

        <!-- Mobile Sidebar Toggle -->
        <div class="fixed bottom-6 left-6 z-40 md:hidden">
            <button onclick="toggleSidebar()" class="bg-primary-600 dark:bg-primary-700 text-white p-4 rounded-full shadow-lg hover:bg-primary-500 dark:hover:bg-primary-600 transition-all duration-300">
                <i id="sidebarIcon" class="bi bi-list text-xl"></i>
            </button>
        </div>
        
        <!-- Main Content Area -->
<div class="flex-1 p-4 md:p-8">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 md:p-6 transition-colors duration-300">
        <h2 class="text-2xl font-bold mb-4 text-gray-800 dark:text-white flex items-center">
            <i class="bi bi-car-front mr-3 text-primary-600 dark:text-primary-400"></i>
            Taxi Search
        </h2>
        <p class="text-gray-600 dark:text-gray-300 mb-6">Find and join taxi groups for shared rides to save money and reduce carbon footprint.</p>
        
        <div class="flex flex-col lg:flex-row gap-6">
            <!-- Left Section - Create Trip -->
            <div class="w-full lg:w-1/3">
                <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 md:p-6 shadow-md transition-colors duration-300">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800 dark:text-white flex items-center">
                        <i class="bi bi-plus-circle mr-2 text-secondary-600 dark:text-secondary-400"></i>
                        Create New Trip
                    </h3>
                    <form id="tripForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Destination</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="bi bi-geo-alt text-gray-400"></i>
                                </div>
                                <input type="text" id="destination" class="pl-10 block w-full rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-white shadow-sm focus:border-primary-500 focus:ring focus:ring-primary-500 focus:ring-opacity-50 transition-colors duration-300" required>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Date</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="bi bi-calendar text-gray-400"></i>
                                </div>
                                <input type="date" id="date" class="pl-10 block w-full rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-white shadow-sm focus:border-primary-500 focus:ring focus:ring-primary-500 focus:ring-opacity-50 transition-colors duration-300" required>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Time</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="bi bi-clock text-gray-400"></i>
                                </div>
                                <input type="time" id="time" class="pl-10 block w-full rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-white shadow-sm focus:border-primary-500 focus:ring focus:ring-primary-500 focus:ring-opacity-50 transition-colors duration-300" required>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Required Members</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="bi bi-people text-gray-400"></i>
                                </div>
                                <input type="number" id="members" min="1" max="100" class="pl-10 block w-full rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-white shadow-sm focus:border-primary-500 focus:ring focus:ring-primary-500 focus:ring-opacity-50 transition-colors duration-300" required>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Phone Number</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="bi bi-telephone text-gray-400"></i>
                                </div>
                                <input type="tel" id="phone" class="pl-10 block w-full rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-white shadow-sm focus:border-primary-500 focus:ring focus:ring-primary-500 focus:ring-opacity-50 transition-colors duration-300" pattern="[0-9]{10}" placeholder="Enter 10-digit number" required>
                            </div>
                        </div>
                        <button type="submit" class="w-full bg-gradient-to-r from-primary-600 to-secondary-600 dark:from-primary-700 dark:to-secondary-700 text-white px-4 py-2 rounded-lg hover:from-primary-700 hover:to-secondary-700 dark:hover:from-primary-600 dark:hover:to-secondary-600 transition-all duration-300 transform hover:-translate-y-1 shadow-md flex items-center justify-center">
                            <i class="bi bi-plus-circle mr-2"></i>
                            Create Trip
                        </button>
                    </form>
                </div>
            </div>

            <!-- Right Section - Available Trips -->
            <div class="w-full lg:w-2/3">
                <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 md:p-6 shadow-md h-full transition-colors duration-300">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 md:mb-6 gap-4">
                        <h3 class="text-xl font-semibold text-gray-800 dark:text-white flex items-center">
                            <i class="bi bi-list-ul mr-2 text-secondary-600 dark:text-secondary-400"></i>
                            Available Trips
                        </h3>
                        <div class="flex flex-col md:flex-row gap-2 w-full md:w-auto">
                            
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="bi bi-search text-gray-400"></i>
                                </div>
                                <input type="text" id="searchTrip" placeholder="Search trips..." class="pl-10 rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-white shadow-sm focus:border-primary-500 focus:ring focus:ring-primary-500 focus:ring-opacity-50 w-full md:w-auto transition-colors duration-300">
                            </div>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="bi bi-sort-down text-gray-400"></i>
                                </div>
                                <select id="sortTrips" class="pl-10 rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-white shadow-sm focus:border-primary-500 focus:ring focus:ring-primary-500 focus:ring-opacity-50 w-full md:w-auto transition-colors duration-300">
                                    <option value="date">Sort by Date</option>
                                    <option value="destination">Sort by Destination</option>
                                    <option value="spots">Sort by Available Spots</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="flex bg-white dark:bg-gray-800 rounded-lg border border-gray-300 dark:border-gray-600 p-1 shadow-sm">
                        <button id="filterAll" class="px-3 py-1 text-sm rounded-md bg-primary-500 text-white">All</button>
                        <button id="filterMyTrips" class="px-3 py-1 text-sm rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">My Trips</button>
                        <button id="filterJoined" class="px-3 py-1 text-sm rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">Joined</button>
                    </div>
                    <div id="tripsList" class="space-y-4 overflow-y-auto max-h-[500px] pr-1">
                        
                        
                        <!-- Empty State -->
                        <div class="text-center text-gray-500 dark:text-gray-400 py-8 bg-white/50 dark:bg-gray-800/50 rounded-lg">
                            <div class="flex flex-col items-center justify-center">
                                <i class="bi bi-car-front text-4xl mb-2 text-gray-400 dark:text-gray-500"></i>
                                <p>No trips available. Create one to get started!</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Join Trip Modal -->
<div id="joinModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden backdrop-blur-sm">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 max-w-md w-full m-4 animate-fade-in">
        <h3 class="text-xl font-semibold mb-4 text-gray-800 dark:text-white flex items-center">
            <i class="bi bi-person-plus mr-2 text-secondary-600 dark:text-secondary-400"></i>
            Confirm Join Trip
        </h3>
        <p class="text-gray-600 dark:text-gray-300 mb-4">Are you sure you want to join this trip?</p>
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Your Phone Number</label>
            <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <i class="bi bi-telephone text-gray-400"></i>
                </div>
                <input type="tel" id="joinPhone" class="pl-10 mb-4 block w-full rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-white shadow-sm focus:border-primary-500 focus:ring focus:ring-primary-500 focus:ring-opacity-50 transition-colors duration-300" pattern="[0-9]{10}" placeholder="Enter 10-digit number" required>
            </div>
        </div>
        <div class="flex justify-end space-x-2">
            <button id="cancelJoin" class="px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors duration-300 flex items-center">
                <i class="bi bi-x mr-1"></i>
                Cancel
            </button>
            <button id="confirmJoin" class="px-4 py-2 rounded-lg bg-gradient-to-r from-primary-600 to-secondary-600 dark:from-primary-700 dark:to-secondary-700 text-white hover:from-primary-700 hover:to-secondary-700 transition-colors duration-300 flex items-center">
                <i class="bi bi-check2 mr-1"></i>
                Join Trip
            </button>
        </div>
    </div>
</div>

<!-- Leave Trip Modal -->
<div id="leaveModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden backdrop-blur-sm">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 max-w-md w-full m-4 animate-fade-in">
        <h3 class="text-xl font-semibold mb-4 text-gray-800 dark:text-white flex items-center">
            <i class="bi bi-person-dash mr-2 text-tertiary-600 dark:text-tertiary-400"></i>
            Confirm Leave Trip
        </h3>
        <p class="text-gray-600 dark:text-gray-300 mb-4">Are you sure you want to leave this trip? This will free up your spot for other students.</p>
        <div class="flex justify-end space-x-2">
            <button id="cancelLeave" class="px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors duration-300 flex items-center">
                <i class="bi bi-x mr-1"></i>
                Cancel
            </button>
            <button id="confirmLeave" class="px-4 py-2 rounded-lg bg-tertiary-600 hover:bg-tertiary-700 text-white transition-colors duration-300 flex items-center">
                <i class="bi bi-box-arrow-right mr-1"></i>
                Leave Trip
            </button>
        </div>
    </div>
</div>
</div>

        
    

    
<script>
    let currentFilter = 'all';
     // ==== THEME FUNCTIONALITY ====
function toggleTheme() {
    // Check if currently in dark mode
    const isDarkMode = document.documentElement.classList.contains('dark');
    
    // Toggle the dark class on the html element
    document.documentElement.classList.toggle('dark');
    
    // Update the icon based on current theme
    const themeIcon = document.getElementById('themeIcon');
    if (isDarkMode) {
        // Switching to light mode
        themeIcon.classList.remove('bi-moon');
        themeIcon.classList.add('bi-sun');
    } else {
        // Switching to dark mode
        themeIcon.classList.remove('bi-sun');
        themeIcon.classList.add('bi-moon');
    }
    
    // Save preference to localStorage
    localStorage.setItem('theme', isDarkMode ? 'light' : 'dark');
}

// Function to initialize theme based on saved preference
function initializeTheme() {
    // Check for saved theme preference or use system preference
    const savedTheme = localStorage.getItem('theme');
    
    if (savedTheme) {
        // Apply saved preference
        if (savedTheme === 'dark') {
            document.documentElement.classList.add('dark');
            document.getElementById('themeIcon').classList.remove('bi-sun');
            document.getElementById('themeIcon').classList.add('bi-moon');
        } else {
            document.documentElement.classList.remove('dark');
            document.getElementById('themeIcon').classList.remove('bi-moon');
            document.getElementById('themeIcon').classList.add('bi-sun');
        }
    } else {
        // Apply system preference
        if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
            document.getElementById('themeIcon').classList.remove('bi-sun');
            document.getElementById('themeIcon').classList.add('bi-moon');
        }
    }
}

// ==== RESPONSIVE FUNCTIONALITY ====
function setupResponsiveness() {
    // Adjust UI based on screen size
    const handleResize = () => {
        const width = window.innerWidth;
        const sidebar = document.getElementById('sidebar');
        const contentArea = document.getElementById('contentArea');
        
        // Sidebar handling based on screen size
        if (width < 768) { // Mobile view
            sidebar.classList.add('-translate-x-full');
            sidebar.classList.add('fixed');
            sidebar.classList.remove('relative');
            
            // Adjust content area
            contentArea.classList.remove('ml-64');
        } else { // Desktop view
            sidebar.classList.remove('-translate-x-full');
            sidebar.classList.remove('fixed');
            sidebar.classList.add('relative');
            
            // Reset content area
            contentArea.classList.add('ml-64');
        }
    };
    
    // Call once on load
    handleResize();
    
    // Add event listener for window resize
    window.addEventListener('resize', handleResize);
}

// Toggle mobile sidebar
function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const sidebarIcon = document.getElementById('sidebarIcon');
    
    sidebar.classList.toggle('-translate-x-full');
    
    // Update icon based on sidebar state
    if (sidebar.classList.contains('-translate-x-full')) {
        sidebarIcon.classList.remove('bi-x-lg');
        sidebarIcon.classList.add('bi-list');
    } else {
        sidebarIcon.classList.remove('bi-list');
        sidebarIcon.classList.add('bi-x-lg');
    }
}

// Logout function
window.logout = async function() {
        try {
            const { error } = await window.supabaseClient.auth.signOut();
            if (error) throw error;
            
            // Clear session storage
            sessionStorage.removeItem('currentUserData');
            
            // Redirect to login
            window.location.href = 'index.html';
        } catch (error) {
            console.error('Error signing out:', error);
            alert('Error signing out: ' + error.message);
        }
    };



    document.addEventListener('DOMContentLoaded', function() {
    // Initialize Supabase
    const supabaseUrl = 'https://cebomekzvltlaabcvjix.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNlYm9tZWt6dmx0bGFhYmN2aml4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM3NjUwNjQsImV4cCI6MjA1OTM0MTA2NH0.dtlBNgdctrv-txCEpNxjpfwzL02X0g7msUZIVuzG9J8';
    
    // Create a proper client instance
    window.supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
    
    // Initialize user data from session storage
    let currentUser = { name: 'User', email: 'user@example.com', phone: '' };
    
    // Check if we're in a logged-in session
    checkSession();
    ensureModalsExist();
    

    // Initialize trips
    let trips = [];

    document.getElementById('filterAll').addEventListener('click', function() {
    setActiveFilter('all');
    applyFilters();
});

document.getElementById('filterMyTrips').addEventListener('click', function() {
    setActiveFilter('myTrips');
    applyFilters();
});

document.getElementById('filterJoined').addEventListener('click', function() {
    setActiveFilter('joined');
    applyFilters();
});
    
    

    
    document.getElementById('tripForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const destination = document.getElementById('destination').value;
        const date = document.getElementById('date').value;
        const time = document.getElementById('time').value;
        const members = parseInt(document.getElementById('members').value);
        const phone = document.getElementById('phone').value;
        
        // Validate date
        const tripDate = new Date(date);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        if (tripDate < today) {
            alert('Please select a future date.');
            return;
        }
        
        // Update current user's phone
        currentUser.phone = phone;
        
        // Create joined members array with current user
        const joinedMembers = [{
            name: currentUser.name,
            email: currentUser.email,
            phone: phone
        }];
        
        try {
            // Insert trip into Supabase
            const { data, error } = await window.supabaseClient
                .from('taxi_trips')
                .insert([{
                    destination: destination,
                    date: date,
                    time: time,
                    max_members: members,
                    creator: currentUser.name,
                    creator_email: currentUser.email,
                    creator_phone: phone,
                    joined_members: joinedMembers,
                    comments: []
                }])
                .select();
                
            if (error) throw error;
            
            // Refresh trips list
            fetchTrips();
            this.reset();
        } catch (error) {
            alert('Error creating trip: ' + error.message);
            console.error('Detailed error:', error);
        }
    });

    // Function to delete expired trips
    async function deletePastTrips() {
        try {
            // Get yesterday's date (to ensure we're not deleting trips scheduled for today)
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() -1);
            const yesterdayStr = yesterday.toISOString().split('T')[0];
            
            console.log('Deleting trips older than:', yesterdayStr);
            
            // Delete trips with dates in the past
            const { data, error } = await window.supabaseClient
                .from('taxi_trips')
                .delete()
                .lt('date', yesterdayStr);
                
            if (error) throw error;
            
            console.log('Deleted past trips:', data);
            
            // No need to return anything as we're just cleaning up
        } catch (error) {
            console.error('Error deleting past trips:', error);
        }
    }
    function setActiveFilter(filter) {
    // Update current filter
    currentFilter = filter;
    
    // Update button styles
    const filterButtons = {
        'all': document.getElementById('filterAll'),
        'myTrips': document.getElementById('filterMyTrips'),
        'joined': document.getElementById('filterJoined')
    };
    
    // Reset all buttons to inactive state
    Object.values(filterButtons).forEach(button => {
        button.classList.remove('bg-primary-500', 'text-white');
        button.classList.add('text-gray-700', 'dark:text-gray-300', 'hover:bg-gray-100', 'dark:hover:bg-gray-700');
    });
    
    // Set active button
    filterButtons[filter].classList.remove('text-gray-700', 'dark:text-gray-300', 'hover:bg-gray-100', 'dark:hover:bg-gray-700');
    filterButtons[filter].classList.add('bg-primary-500', 'text-white');
}

// Function to apply all filters (search + filter type + sort)
async function applyFilters() {
    try {
        // Clean up past trips first
        await deletePastTrips();
        
        // Get today's date for filtering expired trips
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const todayStr = today.toISOString().split('T')[0];
        
        // Base query
        let query = window.supabaseClient
            .from('taxi_trips')
            .select('*')
            .gte('date', todayStr);
        
        // Apply search filter if present
        const searchTerm = document.getElementById('searchTrip').value.toLowerCase();
        if (searchTerm) {
            query = query.ilike('destination', `%${searchTerm}%`);
        }
        
        // Apply sorting
        const sortBy = document.getElementById('sortTrips').value;
        if (sortBy === 'date') {
            query = query.order('date', { ascending: true });
        } else if (sortBy === 'destination') {
            query = query.order('destination', { ascending: true });
        } else {
            // For 'spots', we'll fetch all and sort manually
            query = query.order('created_at', { ascending: false });
        }
        
        const { data, error } = await query;
        
        if (error) throw error;
        
        // Start with all trips
        let filteredTrips = data || [];
        
        // Apply trip type filter (my trips, joined)
        if (currentFilter === 'myTrips') {
            filteredTrips = filteredTrips.filter(trip => trip.creator_email === currentUser.email);
        } else if (currentFilter === 'joined') {
            filteredTrips = filteredTrips.filter(trip => {
                // Include trips where user is a member but NOT the creator
                const joinedMembers = trip.joined_members || [];
                return joinedMembers.some(member => member.email === currentUser.email) && 
                       trip.creator_email !== currentUser.email;
            });
        }
        
        // For spots sorting, we need custom sort logic
        if (sortBy === 'spots') {
            filteredTrips.sort((a, b) => {
                const aSpots = a.max_members - (a.joined_members?.length || 0);
                const bSpots = b.max_members - (b.joined_members?.length || 0);
                return bSpots - aSpots;
            });
        }
        
        // Update global trips variable and render
        trips = filteredTrips;
        renderTrips();
    } catch (error) {
        console.error('Error applying filters:', error);
    }
}
    // Fetch trips from Supabase
    async function fetchTrips() {
    try {
        // First, delete past trips
        await deletePastTrips();
        
        // Get today's date for filtering
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const todayStr = today.toISOString().split('T')[0];
        
        // Fetch trips from Supabase
        const { data, error } = await window.supabaseClient
            .from('taxi_trips')
            .select('*')
            .gte('date', todayStr)
            .order('created_at', { ascending: false });
            
        if (error) throw error;
        
        // Start with all trips
        let allTrips = data || [];
        
        // Apply current filter
        if (currentFilter === 'myTrips') {
            trips = allTrips.filter(trip => trip.creator_email === currentUser.email);
        } else if (currentFilter === 'joined') {
            trips = allTrips.filter(trip => {
                const joinedMembers = trip.joined_members || [];
                return joinedMembers.some(member => member.email === currentUser.email) && 
                       trip.creator_email !== currentUser.email;
            });
        } else {
            trips = allTrips;
        }
        
        renderTrips();
    } catch (error) {
        console.error('Error fetching trips:', error);
    }
}

    // Render trips
    // Add these functions after the existing ones in your script

// Add edit and delete buttons only for trip creators
function renderTrips() {
    const tripsContainer = document.getElementById('tripsList');
    tripsContainer.innerHTML = '';
    
    if (trips.length === 0) {
        tripsContainer.innerHTML = `
            <div class="text-center text-gray-500 dark:text-gray-400 py-8 bg-white/50 dark:bg-gray-800/50 rounded-lg">
                <div class="flex flex-col items-center justify-center">
                    <i class="bi bi-car-front text-4xl mb-2 text-gray-400 dark:text-gray-500"></i>
                    <p>No trips available. Create one to get started!</p>
                </div>
            </div>
        `;
        return;
    }
    
    trips.forEach(trip => {
        const joinedMembers = trip.joined_members || [];
        
        // Check if current user has already joined this trip
        const isJoined = joinedMembers.some(member => member.email === currentUser.email);
        const isFull = joinedMembers.length >= trip.max_members;
        
        // Check if current user is the creator
        const isCreator = trip.creator_email === currentUser.email;
        
        const tripCard = document.createElement('div');
        tripCard.className = 'bg-white dark:bg-gray-800 rounded-lg p-4 shadow-md transition-colors duration-300 border-l-4 border-primary-500 dark:border-primary-600 hover:shadow-lg';
        
        tripCard.innerHTML = `
            <div class="flex flex-col md:flex-row justify-between md:items-center gap-4">
                <div>
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-white flex items-center">
                        <i class="bi bi-geo-alt text-secondary-600 dark:text-secondary-400 mr-2"></i>
                        ${trip.destination}
                    </h3>
                    <div class="flex flex-wrap gap-x-4 gap-y-2 mt-2 text-gray-600 dark:text-gray-300">
                        <p class="flex items-center">
                            <i class="bi bi-calendar mr-1 text-gray-500 dark:text-gray-400"></i>
                            ${formatDate(trip.date)}
                        </p>
                        <p class="flex items-center">
                            <i class="bi bi-clock mr-1 text-gray-500 dark:text-gray-400"></i>
                            ${formatTime(trip.time)}
                        </p>
                        <p class="flex items-center">
                            <i class="bi bi-people mr-1 text-gray-500 dark:text-gray-400"></i>
                            <span class="${joinedMembers.length >= trip.max_members ? 'text-red-500 dark:text-red-400' : 'text-green-500 dark:text-green-400'}">
                                ${joinedMembers.length}/${trip.max_members}
                            </span>
                        </p>
                    </div>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-1 flex items-center">
                        <i class="bi bi-person-circle mr-1"></i>
                        Created by: ${trip.creator} (${maskPhone(trip.creator_phone)})
                    </p>
                </div>
                <div class="flex flex-col gap-2">
                    ${isCreator ? `
                        <div class="flex gap-2">
                            <button 
                                onclick="initiateEditTrip(${trip.id})" 
                                class="bg-amber-500 hover:bg-amber-600 text-white px-3 py-2 rounded-lg transition-all duration-300 transform hover:-translate-y-1 shadow-sm flex items-center justify-center">
                                <i class="bi bi-pencil mr-2"></i>
                                Edit
                            </button>
                            <button 
                                onclick="initiateDeleteTrip(${trip.id})" 
                                class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-lg transition-all duration-300 transform hover:-translate-y-1 shadow-sm flex items-center justify-center">
                                <i class="bi bi-trash mr-2"></i>
                                Delete
                            </button>
                        </div>
                    ` : ''}
                    ${isJoined ? 
                        `<button 
                            onclick="initiateLeaveTrip(${trip.id})" 
                            class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-all duration-300 transform hover:-translate-y-1 shadow-sm flex items-center justify-center">
                            <i class="bi bi-box-arrow-left mr-2"></i>
                            Leave
                        </button>` : 
                        `<button 
                            onclick="initiateJoinTrip(${trip.id})" 
                            class="${isFull ? 'bg-gray-400 cursor-not-allowed' : 'bg-gradient-to-r from-primary-600 to-secondary-600 dark:from-primary-700 dark:to-secondary-700 hover:from-primary-700 hover:to-secondary-700 dark:hover:from-primary-600 dark:hover:to-secondary-600'} text-white px-4 py-2 rounded-lg transition-all duration-300 transform ${!isFull ? 'hover:-translate-y-1' : ''} shadow-sm flex items-center justify-center"
                            ${isFull ? 'disabled' : ''}>
                            <i class="bi bi-${isFull ? 'x-circle' : 'plus-circle'} mr-2"></i>
                            ${isFull ? 'Full' : 'Join'}
                        </button>`
                    }
                </div>
            </div>
            
            <div class="mt-4 bg-gray-50 dark:bg-gray-700 rounded-lg p-3 transition-colors duration-300">
                <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 flex items-center">
                    <i class="bi bi-people-fill mr-2 text-primary-600 dark:text-primary-400"></i>
                    Members:
                </h4>
                <ul class="mt-2 text-sm text-gray-600 dark:text-gray-400 space-y-1">
                    ${joinedMembers.map(member => `
                        <li class="flex items-center">
                            <i class="bi bi-person-fill text-gray-500 dark:text-gray-400 mr-2"></i>
                            ${member.name} (${member.email}) - Phone: ${maskPhone(member.phone)}
                        </li>
                    `).join('')}
                </ul>
            </div>
            
            <div class="mt-4">
                <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 flex items-center">
                    <i class="bi bi-chat-dots mr-2 text-primary-600 dark:text-primary-400"></i>
                    Comments:
                </h4>
                <div class="mt-2 space-y-2">
                    ${(trip.comments || []).map(comment => `
                        <div class="text-sm bg-gray-50 dark:bg-gray-700 p-3 rounded-lg transition-colors duration-300">
                            <p class="font-medium flex items-center">
                                <i class="bi bi-person-circle mr-1 text-gray-500 dark:text-gray-400"></i>
                                ${comment.user}:
                            </p>
                            <p class="mt-1 text-gray-600 dark:text-gray-300">${comment.text}</p>
                        </div>
                    `).join('')}
                </div>
                <div class="flex items-center space-x-2 mt-3">
                    <div class="relative flex-1">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="bi bi-chat text-gray-400"></i>
                        </div>
                        <input type="text" id="comment-${trip.id}" placeholder="Add a comment..." class="pl-10 w-full text-sm rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-white focus:border-primary-500 focus:ring focus:ring-primary-500 focus:ring-opacity-50 transition-colors duration-300">
                    </div>
                    <button onclick="addComment(${trip.id})" class="bg-gray-200 dark:bg-gray-700 p-2 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors duration-300">
                        <i class="bi bi-send"></i>
                    </button>
                </div>
            </div>
        `;
        tripsContainer.appendChild(tripCard);
    });
}

// Edit trip modal functions - Updated to ensure modals exist first
window.initiateEditTrip = function(tripId) {
    // First make sure modals exist
    ensureModalsExist();
    
    const trip = trips.find(t => t.id === tripId);
    
    if (trip && trip.creator_email === currentUser.email) {
        // Now safely populate edit form with current trip details
        document.getElementById('editDestination').value = trip.destination;
        document.getElementById('editDate').value = trip.date;
        document.getElementById('editTime').value = trip.time;
        document.getElementById('editMembers').value = trip.max_members;
        
        window.selectedTripId = tripId;
        document.getElementById('editModal').classList.remove('hidden');
    } else {
        alert('Only the trip creator can edit this trip.');
    }
};

// Initialize delete trip - Updated to ensure modals exist first
window.initiateDeleteTrip = function(tripId) {
    // First make sure modals exist
    ensureModalsExist();
    
    const trip = trips.find(t => t.id === tripId);
    
    if (trip && trip.creator_email === currentUser.email) {
        window.selectedTripId = tripId;
        document.getElementById('deleteModal').classList.remove('hidden');
    } else {
        alert('Only the trip creator can delete this trip.');
    }
};

// Edit trip functionality
async function editTrip(tripId, destination, date, time, maxMembers) {
    try {
        // First, get current trip to check permissions and current members
        const { data: trip, error: tripError } = await window.supabaseClient
            .from('taxi_trips')
            .select('creator_email, joined_members')
            .eq('id', tripId)
            .single();
            
        if (tripError) throw tripError;
        
        // Verify user is the creator
        if (trip.creator_email !== currentUser.email) {
            throw new Error('Only the trip creator can edit this trip');
        }
        
        const joinedMembers = trip.joined_members || [];
        
        // Make sure new max members is not less than current members
        if (maxMembers < joinedMembers.length) {
            throw new Error(`Cannot reduce maximum members below current count (${joinedMembers.length})`);
        }
        
        // Update trip in Supabase
        const { error: updateError } = await window.supabaseClient
            .from('taxi_trips')
            .update({
                destination: destination,
                date: date,
                time: time,
                max_members: maxMembers
            })
            .eq('id', tripId);
            
        if (updateError) throw updateError;
        
        alert('Trip updated successfully!');
        
        // Refresh trips
        fetchTrips();
    } catch (error) {
        console.error('Error editing trip:', error);
        alert('Failed to edit trip: ' + error.message);
    }
}

// Delete trip functionality
async function deleteTrip(tripId) {
    try {
        // First, get current trip to check permissions
        const { data: trip, error: tripError } = await window.supabaseClient
            .from('taxi_trips')
            .select('creator_email')
            .eq('id', tripId)
            .single();
            
        if (tripError) throw tripError;
        
        // Verify user is the creator
        if (trip.creator_email !== currentUser.email) {
            throw new Error('Only the trip creator can delete this trip');
        }
        
        // Delete trip from Supabase
        const { error: deleteError } = await window.supabaseClient
            .from('taxi_trips')
            .delete()
            .eq('id', tripId);
            
        if (deleteError) throw deleteError;
        
        alert('Trip deleted successfully!');
        
        // Refresh trips
        fetchTrips();
    } catch (error) {
        console.error('Error deleting trip:', error);
        alert('Failed to delete trip: ' + error.message);
    }
}

// Enhance the leave trip functionality to handle creator transfers
async function leaveTrip(tripId) {
    try {
        // Get current trip data
        const { data: trip, error: tripError } = await window.supabaseClient
            .from('taxi_trips')
            .select('joined_members, creator_email, comments')
            .eq('id', tripId)
            .single();
            
        if (tripError) throw tripError;
        
        const joinedMembers = trip.joined_members || [];
        
        // Check if user is the creator of the trip
        const isCreator = trip.creator_email === currentUser.email;
        
        if (isCreator && joinedMembers.length === 1) {
            // If creator is the only member, delete the entire trip
            const { error: deleteError } = await window.supabaseClient
                .from('taxi_trips')
                .delete()
                .eq('id', tripId);
                
            if (deleteError) throw deleteError;
            
            alert('You were the only member. Trip has been deleted.');
        } else {
            // Remove the user from joined members
            const updatedMembers = joinedMembers.filter(member => 
                member.email !== currentUser.email
            );
            
            let updateData = { joined_members: updatedMembers };
            
            // If creator is leaving but there are other members
            if (isCreator && updatedMembers.length > 0) {
                // Assign a new creator (first member in the list)
                const newCreator = updatedMembers[0];
                updateData.creator = newCreator.name;
                updateData.creator_email = newCreator.email;
                updateData.creator_phone = newCreator.phone;
                
                // Add a comment noting the creator transfer
                const comments = trip.comments || [];
                comments.push({
                    user: 'System',
                    text: `${currentUser.name} left the trip. ${newCreator.name} is now the trip creator.`,
                    timestamp: new Date().toISOString()
                });
                updateData.comments = comments;
            }
            
            // Update trip in Supabase
            const { error: updateError } = await window.supabaseClient
                .from('taxi_trips')
                .update(updateData)
                .eq('id', tripId);
                
            if (updateError) throw updateError;
            
            if (isCreator && updatedMembers.length > 0) {
                alert(`You've left the trip. ${updateData.creator} is now the trip creator.`);
            } else {
                alert('You\'ve left the trip successfully.');
            }
        }
        
        // Refresh trips
        fetchTrips();
    } catch (error) {
        console.error('Error leaving trip:', error);
        alert('Failed to leave trip: ' + error.message);
    }
}
    // Mask phone number for privacy (show only last 4 digits)
    function maskPhone(phone) {
        if (!phone) return "Not provided";
        return phone;
    }

    // Format date
    function formatDate(dateStr) {
        const options = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' };
        return new Date(dateStr).toLocaleDateString(undefined, options);
    }

    // Format time
    function formatTime(timeStr) {
        return timeStr;
    }

    // Make functions global for event handlers
    window.initiateJoinTrip = function(tripId) {
        const trip = trips.find(t => t.id === tripId);
        const joinedMembers = trip.joined_members || [];
        
        // Check if current user has already joined this trip
        const isJoined = joinedMembers.some(member => member.email === currentUser.email);
        
        if (trip && joinedMembers.length < trip.max_members && !isJoined) {
            window.selectedTripId = tripId;
            document.getElementById('joinModal').classList.remove('hidden');
        }
    };

    window.initiateLeaveTrip = function(tripId) {
        window.selectedTripId = tripId;
        document.getElementById('leaveModal').classList.remove('hidden');
    };

    window.addComment = async function(tripId) {
        const commentInput = document.getElementById(`comment-${tripId}`);
        const commentText = commentInput.value.trim();
        
        if (commentText) {
            try {
                // Get current trip
                const { data: tripData, error: tripError } = await window.supabaseClient
                    .from('taxi_trips')
                    .select('comments')
                    .eq('id', tripId)
                    .single();
                    
                if (tripError) throw tripError;
                
                // Add new comment
                const comments = tripData.comments || [];
                comments.push({
                    user: currentUser.name,
                    text: commentText,
                    timestamp: new Date().toISOString()
                });
                
                // Update trip with new comment
                const { error: updateError } = await window.supabaseClient
                    .from('taxi_trips')
                    .update({ comments: comments })
                    .eq('id', tripId);
                    
                if (updateError) throw updateError;
                
                // Refresh trips
                fetchTrips();
            } catch (error) {
                console.error('Error adding comment:', error);
                alert('Failed to add comment: ' + error.message);
            }
        }
        
        commentInput.value = '';
    };

    // Close join modal
    document.getElementById('cancelJoin').addEventListener('click', function() {
        document.getElementById('joinModal').classList.add('hidden');
        window.selectedTripId = null;
    });

    // Confirm join
    document.getElementById('confirmJoin').addEventListener('click', async function() {
        const phone = document.getElementById('joinPhone').value;
        if (!phone) {
            alert('Please enter your phone number.');
            return;
        }
        
        if (window.selectedTripId) {
            await joinTrip(window.selectedTripId, phone);
            document.getElementById('joinModal').classList.add('hidden');
            window.selectedTripId = null;
        }
    });

    // Join trip functionality
    async function joinTrip(tripId, phone) {
        try {
            // Get current trip data
            const { data: trip, error: tripError } = await window.supabaseClient
                .from('taxi_trips')
                .select('joined_members, max_members')
                .eq('id', tripId)
                .single();
                
            if (tripError) throw tripError;
            
            const joinedMembers = trip.joined_members || [];
            
            // Check if user has already joined
            const isJoined = joinedMembers.some(member => member.email === currentUser.email);
            
            // Check if trip is full
            const isFull = joinedMembers.length >= trip.max_members;
            
            // Only allow join if user hasn't joined and trip isn't full
            if (!isJoined && !isFull) {
                // Update current user's phone
                currentUser.phone = phone;
                
                // Add user to joined members
                joinedMembers.push({ 
                    name: currentUser.name, 
                    email: currentUser.email,
                    phone: phone
                });
                
                // Update trip in Supabase
                const { error: updateError } = await window.supabaseClient
                    .from('taxi_trips')
                    .update({ joined_members: joinedMembers })
                    .eq('id', tripId);
                    
                if (updateError) throw updateError;
                
                // Refresh trips
                fetchTrips();
            }
        } catch (error) {
            console.error('Error joining trip:', error);
            alert('Failed to join trip: ' + error.message);
        }
    }

    // Close leave modal
    document.getElementById('cancelLeave').addEventListener('click', function() {
        document.getElementById('leaveModal').classList.add('hidden');
        window.selectedTripId = null;
    });

    // Confirm leave
    document.getElementById('confirmLeave').addEventListener('click', async function() {
        if (window.selectedTripId) {
            await leaveTrip(window.selectedTripId);
            document.getElementById('leaveModal').classList.add('hidden');
            window.selectedTripId = null;
        }
    });

    // Leave trip functionality
    

    // Search functionality
    document.getElementById('searchTrip').addEventListener('input', async function(e) {
        applyFilters();
        const searchTerm = e.target.value.toLowerCase();
        if (searchTerm === '') {
            // If search is empty, fetch all trips
            fetchTrips();
        } else {
            try {
                // Clean up past trips first
                await deletePastTrips();
                
                // Get today's date for filtering expired trips
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const todayStr = today.toISOString().split('T')[0];
                
                // Search trips in Supabase
                const { data, error } = await window.supabaseClient
                    .from('taxi_trips')
                    .select('*')
                    .gte('date', todayStr)
                    .ilike('destination', `%${searchTerm}%`)
                    .order('created_at', { ascending: false });
                    
                if (error) throw error;
                
                trips = data || [];
                renderTrips();
            } catch (error) {
                console.error('Error searching trips:', error);
            }
        }
    });

    // Sort functionality
    document.getElementById('sortTrips').addEventListener('change', async function(e) {
        applyFilters();
        const sortBy = e.target.value;
        
        try {
            // Clean up past trips first
            await deletePastTrips();
            
            // Get today's date for filtering expired trips
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayStr = today.toISOString().split('T')[0];
            
            let query = window.supabaseClient
                .from('taxi_trips')
                .select('*')
                .gte('date', todayStr);
                
            // Apply sorting
            if (sortBy === 'date') {
                query = query.order('date', { ascending: true });
            } else if (sortBy === 'destination') {
                query = query.order('destination', { ascending: true });
            } else {
                // For 'spots', we'll need to fetch all and sort manually
                query = query.order('created_at', { ascending: false });
            }
            
            const { data, error } = await query;
            
            if (error) throw error;
            
            trips = data || [];
            
            // For spots sorting, we need custom sort logic
            if (sortBy === 'spots') {
                trips.sort((a, b) => {
                    const aSpots = a.max_members - (a.joined_members?.length || 0);
                    const bSpots = b.max_members - (b.joined_members?.length || 0);
                    return bSpots - aSpots;
                });
            }
            
            renderTrips();
        } catch (error) {
            console.error('Error sorting trips:', error);
        }
    });

    // Check session
    async function checkSession() {
        try {
            // Check if user is logged in with Supabase
            const { data: { session } } = await window.supabaseClient.auth.getSession();
            
            if (session) {
                // User is logged in, get profile
                const { data: profile, error } = await window.supabaseClient
                    .from('profiles')
                    .select('name, email')
                    .eq('id', session.user.id)
                    .single();
                    
                if (!error && profile) {
                    currentUser = {
                        name: profile.name,
                        email: profile.email,
                        phone: ''
                    };
                    
                    // Update user name in UI
                    document.getElementById('userName').textContent = currentUser.name;
                    
                    // Store user info in sessionStorage
                    sessionStorage.setItem('currentUserData', JSON.stringify(currentUser));
                    
                    // Fetch trips
                    fetchTrips();
                } else {
                    // Redirect to login
                    window.location.href = 'index.html';
                }
            } else {
                // Redirect to login
                window.location.href = 'index.html';
            }
        } catch (error) {
            console.error('Error checking session:', error);
            // Redirect to login
            window.location.href = 'index.html';
        }
    }

    
    
    // Add this function to ensure modals are added to the document
function ensureModalsExist() {
    // Check if edit modal already exists
    if (!document.getElementById('editModal')) {
        // Create and append modals HTML
        const modalsContainer = document.createElement('div');
        modalsContainer.innerHTML = `
            <!-- Edit Trip Modal -->
            <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl w-full max-w-md mx-4">
                    <h3 class="text-xl font-semibold text-gray-800 dark:text-white mb-4 flex items-center">
                        <i class="bi bi-pencil-square mr-2 text-primary-600 dark:text-primary-400"></i>
                        Edit Trip
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label for="editDestination" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Destination</label>
                            <input type="text" id="editDestination" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white" required>
                        </div>
                        <div>
                            <label for="editDate" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Date</label>
                            <input type="date" id="editDate" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white" required>
                        </div>
                        <div>
                            <label for="editTime" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Time</label>
                            <input type="time" id="editTime" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white" required>
                        </div>
                        <div>
                            <label for="editMembers" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Maximum Members</label>
                            <input type="number" id="editMembers" min="1" max="10" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white" required>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button id="cancelEdit" class="px-4 py-2 bg-gray-300 dark:bg-gray-600 text-gray-800 dark:text-white rounded-lg hover:bg-gray-400 dark:hover:bg-gray-500 transition-colors duration-300">
                            Cancel
                        </button>
                        <button id="confirmEdit" class="px-4 py-2 bg-primary-600 dark:bg-primary-700 text-white rounded-lg hover:bg-primary-700 dark:hover:bg-primary-600 transition-colors duration-300">
                            Save Changes
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Delete Trip Modal -->
            <div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl w-full max-w-md mx-4">
                    <h3 class="text-xl font-semibold text-gray-800 dark:text-white mb-4 flex items-center">
                        <i class="bi bi-exclamation-triangle mr-2 text-red-500"></i>
                        Delete Trip
                    </h3>
                    <p class="text-gray-600 dark:text-gray-300 mb-6">
                        Are you sure you want to delete this trip? This action cannot be undone.
                    </p>
                    <div class="flex justify-end space-x-3">
                        <button id="cancelDelete" class="px-4 py-2 bg-gray-300 dark:bg-gray-600 text-gray-800 dark:text-white rounded-lg hover:bg-gray-400 dark:hover:bg-gray-500 transition-colors duration-300">
                            Cancel
                        </button>
                        <button id="confirmDelete" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors duration-300">
                            Delete
                        </button>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modalsContainer);
        
        // Add event listeners to the newly created elements
        setupModalEventListeners();
    }
}

// Function to set up event listeners for modals
function setupModalEventListeners() {
    // Add event listener for cancel edit
    document.getElementById('cancelEdit').addEventListener('click', function() {
        document.getElementById('editModal').classList.add('hidden');
        window.selectedTripId = null;
    });
    
    // Add event listener for confirm edit
    document.getElementById('confirmEdit').addEventListener('click', async function() {
        if (window.selectedTripId) {
            const destination = document.getElementById('editDestination').value;
            const date = document.getElementById('editDate').value;
            const time = document.getElementById('editTime').value;
            const maxMembers = parseInt(document.getElementById('editMembers').value);
            
            // Validate date
            const tripDate = new Date(date);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            if (tripDate < today) {
                alert('Please select a future date.');
                return;
            }
            
            await editTrip(window.selectedTripId, destination, date, time, maxMembers);
            document.getElementById('editModal').classList.add('hidden');
            window.selectedTripId = null;
        }
    });
    
    // Add event listener for cancel delete
    document.getElementById('cancelDelete').addEventListener('click', function() {
        document.getElementById('deleteModal').classList.add('hidden');
        window.selectedTripId = null;
    });
    
    // Add event listener for confirm delete
    document.getElementById('confirmDelete').addEventListener('click', async function() {
        if (window.selectedTripId) {
            await deleteTrip(window.selectedTripId);
            document.getElementById('deleteModal').classList.add('hidden');
            window.selectedTripId = null;
        }
    });
}

    
    
    // Set up periodic cleanup of past trips (run daily)
    setInterval(deletePastTrips, 24 * 60 * 60 * 1000); // 24 hours
    
    // Also run cleanup on page load
    deletePastTrips();
});
</script>
</body>
</html>