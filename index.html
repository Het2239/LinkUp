<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Companion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Poppins', sans-serif;
        }
        .auth-container {
            background: linear-gradient(135deg, #6366f1 0%, #3b82f6 100%);
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        :root {
            color-scheme: light dark;
        }
        .nav-link {
            transition: all 0.3s ease;
        }
        .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }
        #homepage {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900">
    <!-- Auth Container -->
    <div id="authPage" class="auth-container min-h-screen flex items-center justify-center p-4">
        <div class="glass-effect w-full max-w-md p-8 rounded-2xl shadow-xl">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-white mb-2">Student Companion</h1>
                <p class="text-gray-200">Your college life, simplified.</p>
            </div>

            <!-- Auth Tabs -->
            <div class="mb-6">
                <div class="flex space-x-2 mb-6">
                    <button onclick="switchTab('login')" class="flex-1 py-2 px-4 rounded-lg bg-white bg-opacity-20 text-white hover:bg-opacity-30 transition" id="loginTab">Student Login</button>
                    <button onclick="switchTab('admin')" class="flex-1 py-2 px-4 rounded-lg bg-white bg-opacity-20 text-white hover:bg-opacity-30 transition" id="adminTab">Admin Login</button>
                    <button onclick="switchTab('register')" class="flex-1 py-2 px-4 rounded-lg bg-white bg-opacity-20 text-white hover:bg-opacity-30 transition" id="registerTab">Register</button>
                </div>

                <!-- Login Form -->
                <form id="loginForm" class="space-y-4" onsubmit="handleLogin(event)">
                    <div>
                        <input type="email" id="loginEmail" placeholder="Email" class="w-full p-3 rounded-lg bg-white bg-opacity-20 text-white placeholder-gray-300 outline-none" required>
                    </div>
                    <div>
                        <input type="password" id="loginPassword" placeholder="Password" class="w-full p-3 rounded-lg bg-white bg-opacity-20 text-white placeholder-gray-300 outline-none" required>
                    </div>
                    <button type="submit" class="w-full py-3 rounded-lg bg-white text-indigo-600 font-semibold hover:bg-opacity-90 transition">Login</button>
                </form>

                <!-- Admin Form -->
                <form id="adminForm" class="space-y-4 hidden" onsubmit="handleAdminLogin(event)">
                    <div>
                        <input type="password" id="adminPassword" placeholder="Admin Password" class="w-full p-3 rounded-lg bg-white bg-opacity-20 text-white placeholder-gray-300 outline-none" required>
                    </div>
                    <button type="submit" class="w-full py-3 rounded-lg bg-white text-indigo-600 font-semibold hover:bg-opacity-90 transition">Admin Login</button>
                </form>

                <!-- Register Form -->
                <form id="registerForm" class="space-y-4 hidden" onsubmit="handleRegister(event)">
                    <div>
                        <input type="text" id="registerName" placeholder="Full Name" class="w-full p-3 rounded-lg bg-white bg-opacity-20 text-white placeholder-gray-300 outline-none" required>
                    </div>
                    <div>
                        <input type="email" id="registerEmail" placeholder="College Email" class="w-full p-3 rounded-lg bg-white bg-opacity-20 text-white placeholder-gray-300 outline-none" required>
                    </div>
                    <div>
                        <input type="password" id="registerPassword" placeholder="Create Password" class="w-full p-3 rounded-lg bg-white bg-opacity-20 text-white placeholder-gray-300 outline-none" required>
                    </div>
                    <div>
                        <input type="password" id="confirmPassword" placeholder="Confirm Password" class="w-full p-3 rounded-lg bg-white bg-opacity-20 text-white placeholder-gray-300 outline-none" required>
                    </div>
                    <button type="submit" class="w-full py-3 rounded-lg bg-white text-indigo-600 font-semibold hover:bg-opacity-90 transition">Register</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Homepage with Navbar -->
    <div id="homepage" class="min-h-screen bg-gray-50 dark:bg-gray-900">
        <!-- Navbar -->
        <nav class="bg-indigo-600 text-white shadow-lg sticky top-0 z-50">
            <div class="container mx-auto px-4">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center space-x-4">
                        <h1 class="text-2xl font-bold">Student Companion</h1>
                        <span id="welcomeMessage" class="hidden md:inline text-sm">Welcome, <span id="userName">User</span>!</span>
                    </div>
                    
                    <div class="flex items-center">
                        <button id="logoutBtn" class="py-1 px-2 md:py-2 md:px-4 text-xs md:text-base rounded-lg bg-white bg-opacity-20 hover:bg-opacity-30 transition" onclick="logout()">Logout</button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Mobile Menu -->
        <div id="mobileMenu" class="hidden md:hidden bg-indigo-700 text-white">
            <div class="container mx-auto px-4 py-2">
                <button class="w-full text-left py-2 px-4 hover:bg-indigo-600 rounded-lg" onclick="logout()">Logout</button>
            </div>
        </div>

        <!-- Sidebar Navigation -->
        <div class="flex flex-col md:flex-row">
            <!-- Sidebar -->
            <div id="sidebar" class="fixed md:relative w-64 bg-indigo-800 text-white h-screen z-40 transform -translate-x-full md:translate-x-0 transition-transform duration-300">
                <div class="p-4">
                    <h2 class="text-xl font-semibold mb-4">Features</h2>
                    <ul class="space-y-2">
                        <li><a href="notice.html" class="block py-2 px-4 rounded-lg nav-link">Notice Board</a></li>
                        <li><a href="taxi-search.html" class="block py-2 px-4 rounded-lg nav-link">Taxi Search</a></li>
                        <li><a href="study.html" class="block py-2 px-4 rounded-lg nav-link">Study Materials</a></li>
                        <li><a href="mail.html" class="block py-2 px-4 rounded-lg nav-link">Mail Formats</a></li>
                        <li><a href="kyp.html" class="block py-2 px-4 rounded-lg nav-link" >Know Your People</a></li>
                        <li><a href="outings.html" class="block py-2 px-4 rounded-lg nav-link" >Outings & Trips</a></li>
                        <li><a href="messmenu.html" class="block py-2 px-4 rounded-lg nav-link" >Mess & Canteen</a></li>
                    </ul>
                </div>
            </div>

            <div class="fixed bottom-4 left-4 z-40 md:hidden">
                <button onclick="toggleSidebar()" class="bg-indigo-600 text-white p-3 rounded-full shadow-lg">
                    <i class="bi bi-list text-xl"></i>
                </button>
            </div>

            <!-- Main Content -->
            <div class="flex-1 p-8">
                <div id="contentArea" class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                    <!-- Default content (Notice Board) -->
                    <div id="notice" class="content-section">
                        <h2 class="text-2xl font-bold mb-6 text-gray-800 dark:text-white">Notice Board</h2>
                        <p class="text-gray-600 dark:text-gray-300">Welcome to the Student Companion Notice Board! Important announcements and updates will appear here.</p>
                        <div class="mt-6 p-4 bg-gray-100 dark:bg-gray-700 rounded-lg">
                            <h3 class="font-semibold text-gray-800 dark:text-white">No new announcements</h3>
                            <p class="text-gray-600 dark:text-gray-400 text-sm">Check back later for updates</p>
                        </div>
                    </div>

                    <!-- Other content sections (hidden by default) -->
                    <div id="taxi" class="content-section hidden">
                        <h2 class="text-2xl font-bold mb-6 text-gray-800 dark:text-white">Taxi Search</h2>
                        <p class="text-gray-600 dark:text-gray-300">Find and join taxi groups for shared rides.</p>
                    </div>

                    <div id="study" class="content-section hidden">
                        <h2 class="text-2xl font-bold mb-6 text-gray-800 dark:text-white">Study Materials</h2>
                        <p class="text-gray-600 dark:text-gray-300">Access and share study materials and resources.</p>
                    </div>

                    <div id="mail" class="content-section hidden">
                        <h2 class="text-2xl font-bold mb-6 text-gray-800 dark:text-white">Mail Formats</h2>
                        <p class="text-gray-600 dark:text-gray-300">Templates for common emails and important contacts.</p>
                    </div>

                    <div id="people" class="content-section hidden">
                        <h2 class="text-2xl font-bold mb-6 text-gray-800 dark:text-white">Know Your People</h2>
                        <p class="text-gray-600 dark:text-gray-300">Directory of important contacts and representatives.</p>
                    </div>

                    <div id="trips" class="content-section hidden">
                        <h2 class="text-2xl font-bold mb-6 text-gray-800 dark:text-white">Outings & Trips</h2>
                        <p class="text-gray-600 dark:text-gray-300">Plan and join trips and outings with fellow students.</p>
                    </div>

                    <div id="mess" class="content-section hidden">
                        <h2 class="text-2xl font-bold mb-6 text-gray-800 dark:text-white">Mess & Canteen</h2>
                        <p class="text-gray-600 dark:text-gray-300">View mess schedules and canteen menus.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
 document.addEventListener('DOMContentLoaded', function() {
    // Initialize Supabase
    const supabaseUrl = 'https://cebomekzvltlaabcvjix.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNlYm9tZWt6dmx0bGFhYmN2aml4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM3NjUwNjQsImV4cCI6MjA1OTM0MTA2NH0.dtlBNgdctrv-txCEpNxjpfwzL02X0g7msUZIVuzG9J8';
    
    // Create a proper client instance
    window.supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
    
    // Make sure the auth handlers use the client
    initializeAuthHandlers();
    
    // Check session on page load
    checkSession();
});

function initializeAuthHandlers() {
    // Login form handler
    document.getElementById('loginForm').addEventListener('submit', handleLogin);
    
    // Admin form handler
    document.getElementById('adminForm').addEventListener('submit', handleAdminLogin);
    
    // Register form handler
    document.getElementById('registerForm').addEventListener('submit', handleRegister);
}

// Updated auth handlers to use window.supabaseClient
async function handleLogin(e) {
    e.preventDefault();
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    
    try {
        // First, authenticate the user
        const { data, error } = await window.supabaseClient.auth.signInWithPassword({
            email: email,
            password: password,
        });
        
        if (error) {
            // Better error handling for email confirmation
            if (error.message.includes('Email not confirmed')) {
                alert('Please confirm your email address before logging in. Check your inbox for a confirmation email.');
                return;
            }
            throw error;
        }
        
        // User authenticated successfully
        console.log("User authenticated:", data.user.id);
        
        // Get user profile from the profiles table
        const { data: profiles, error: profileError } = await window.supabaseClient
            .from('profiles')
            .select('name')
            .eq('id', data.user.id);
            
        if (profileError) throw profileError;
        
        // Check if we got any profiles back
        if (!profiles || profiles.length === 0) {
            console.log("No profile found, creating one");
            // No profile found, create one
            const { error: insertError } = await window.supabaseClient
                .from('profiles')
                .insert([
                    { 
                        id: data.user.id, 
                        name: email.split('@')[0], // Default name from email
                        email: email 
                    }
                ]);
                
            if (insertError) throw insertError;
            
            // Use email username as default name
            showHomepage(email.split('@')[0]);
        } else {
            // Use the first profile found
            console.log("Profile found:", profiles[0]);
            showHomepage(profiles[0].name);
        }
    } catch (error) {
        alert('Error logging in: ' + error.message);
        console.error("Login error details:", error);
    }
}

async function handleAdminLogin(e) {
    e.preventDefault();
    const password = document.getElementById('adminPassword').value;
    
    try {
        // For admin login, you could use a special admin email or check roles
        const { data, error } = await window.supabaseClient.auth.signInWithPassword({
            email: 'hetchavadiya@gmail.com', // Replace with your admin email
            password: password,
        });
        
        if (error) throw error;
        
        // Check if user has admin role
        const { data: profile, error: profileError } = await window.supabaseClient
            .from('profiles')
            .select('is_admin')
            .eq('id', data.user.id)
            .single();
            
        if (profileError) throw profileError;
        
        if (!profile.is_admin) {
            throw new Error('You do not have admin privileges');
        }
        
        // Admin login successful
        showHomepage('Admin');
    } catch (error) {
        alert('Invalid admin credentials: ' + error.message);
    }
}

async function handleRegister(e) {
    e.preventDefault();
    const name = document.getElementById('registerName').value;
    const email = document.getElementById('registerEmail').value;
    const password = document.getElementById('registerPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    
    // Check if passwords match
    if (password !== confirmPassword) {
        alert('Passwords do not match');
        return;
    }
    
    // Check if username is not "admin" or "Admin"
    if (name === "admin" || name === "Admin") {
        alert('Username cannot be "admin" or "Admin"');
        return;
    }
    
    try {
        // Register user in Supabase Auth
        const { data, error } = await window.supabaseClient.auth.signUp({
            email: email,
            password: password,
            options: {
                emailRedirectTo: window.location.origin,
                data: {
                    name: name
                }
            }
        });
        
        if (error) throw error;
        
        // Add user profile in profiles table
        const { error: profileError } = await window.supabaseClient
            .from('profiles')
            .insert([
                { id: data.user.id, name: name, email: email }
            ]);
            
        if (profileError) throw profileError;
        
        // Check if email confirmation is needed
        if (data.user && !data.user.confirmed_at) {
            alert('Registration successful! Please check your email to confirm your account before logging in.');
        } else {
            alert('Registration successful! You can now log in.');
        }
        
        switchTab('login');
    } catch (error) {
        alert('Error registering: ' + error.message);
        console.error('Detailed error:', error);
    }
}

async function logout() {
    try {
        const { error } = await window.supabaseClient.auth.signOut();
        if (error) throw error;
        
        // Hide homepage
        document.getElementById('homepage').style.display = 'none';
        
        // Show auth page
        document.getElementById('authPage').style.display = 'flex';
        
        // Reset forms
        document.getElementById('loginForm').reset();
        document.getElementById('adminForm').reset();
        document.getElementById('registerForm').reset();
        
        // Switch to login tab
        switchTab('login');
        
        // Clear session storage
        sessionStorage.removeItem('currentUserData');
    } catch (error) {
        alert('Error signing out: ' + error.message);
    }
}

async function checkSession() {
    try {
        // Check if user is logged in with Supabase
        const { data: { session } } = await window.supabaseClient.auth.getSession();
        
        if (session) {
            // User is logged in, get profile
            const { data: profile, error } = await window.supabaseClient
                .from('profiles')
                .select('name')
                .eq('id', session.user.id)
                .single();
                
            if (!error && profile) {
                showHomepage(profile.name);
                
                // Check for page parameter in URL
                const urlParams = new URLSearchParams(window.location.search);
                const page = urlParams.get('page');
                if (page) {
                    loadContent(page);
                }
            }
        }
    } catch (error) {
        console.error('Error checking session:', error);
    }
}

function switchTab(tab) {
    const forms = {
        login: document.getElementById('loginForm'),
        admin: document.getElementById('adminForm'),
        register: document.getElementById('registerForm')
    };
    
    // Hide all forms
    Object.values(forms).forEach(form => form.classList.add('hidden'));
    
    // Show selected form
    forms[tab].classList.remove('hidden');
    
    // Update active tab styling
    document.querySelectorAll('button').forEach(btn => {
        btn.classList.remove('bg-opacity-30');
    });
    document.getElementById(`${tab}Tab`).classList.add('bg-opacity-30');
}

function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    sidebar.classList.toggle('-translate-x-full');
}

function showHomepage(userName) {
    // Hide auth page
    document.getElementById('authPage').style.display = 'none';
    
    // Show homepage
    document.getElementById('homepage').style.display = 'block';
    
    // Set welcome message
    document.getElementById('userName').textContent = userName;
    document.getElementById('welcomeMessage').classList.remove('hidden');
    
    // Store user info in sessionStorage
    sessionStorage.setItem('currentUserData', JSON.stringify({
        name: userName,
        email: document.getElementById('loginEmail').value || 'admin@example.com'

    
    }));
    
}

// Check for system dark mode preference
if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
    document.documentElement.classList.add('dark');
}
    </script>
</body>
</html>